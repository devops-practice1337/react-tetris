# azure-pipelines.yml

trigger:
- master

stages:
# ---------- BUILD ----------
- stage: Build
  displayName: Build React app
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: LocalPool
    steps:
    - task: NodeTool@0
      displayName: Install Node.js
      inputs:
        versionSpec: '20.x'

    - script: |
        npm install
        npm run build
      displayName: npm ci & build

    - task: PublishPipelineArtifact@1
      displayName: Publish build artifact
      inputs:
        targetPath: 'build'
        artifact: 'react_build'
        publishLocation: 'pipeline'

# ---------- DEPLOY ----------
- stage: Deploy_Dev
  displayName: Deploy to dev1
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployToDev1
    displayName: Deploy to Environment dev1
    environment: dev1
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: Download artifact
            inputs:
              artifact: 'react_build'
              path: '$(Pipeline.Workspace)/react_build'

          - script: |
              set -e
              sudo mkdir -p /var/www/myapp
              rsync -av --delete "$(Pipeline.Workspace)/react_build/" "/var/www/myapp/"
            displayName: Sync files to web root

          - script: |
              if command -v systemctl >/dev/null 2>&1; then
                sudo systemctl reload nginx || sudo systemctl restart nginx
              else
                sudo service nginx reload || sudo service nginx restart
              fi
            displayName: Reload web server
